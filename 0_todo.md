# Tamter 

## Architecture Decision : Direct HTTP

### Recommendation: 

## System Architecture Overview

``` 
  ┌───────────────────────────────────────────────────────┐
  │                 CLIENT APPLICATIONS                   │
  ├──────────────────────────────────┬────────────────────┤
  │         REST API Clients         │                    │
  │                                  │                    │
  │ ┌──────────┐  ┌──────────┐  ┌──────────┐              │
  │ │ Web App  │  │  Mobile  │  │ Desktop  │              │
  │ │ Frontend │  │   App    │  │   App    │              │
  │ │   🌐    │  │    📱    │  │    💻    │              │      
  │ └────┬─────┘  └────┬─────┘  └────┬─────┘              │
  │      │              │            │                    │
  │      │HTTP/JSON     │HTTP/JSON   │HTTP/JSON           │
  │      │              │            │                    │
  └──────────────────────────────────┬────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           LOAD BALANCER LAYER                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    GCP Load Balancer 🔄                             │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │                                                                     │    │
│  │  ┌─────────────────────┐    ┌─────────────────────┐                 │    │
│  │  │   Health Checks     │    │   Traffic Routing   │                 │    │
│  │  │ • Service health    │    │ • Round robin       │                 │    │
│  │  │ • Response time     │    │ • Weighted routing  │                 │    │
│  │  │ • Error rates       │    │ • Geo-based routing │                 │    │
│  │  └─────────────────────┘    └─────────────────────┘                 │    │
│  │                                                                     │    │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │    │
│  │  │                   Load Balancing Features                       │ │    │
│  │  │ • SSL termination           • Rate limiting                     │ │    │
│  │  │ • DDoS protection          • Request routing                    │ │    │
│  │  │ • Auto-scaling triggers    • Circuit breaker                    │ │    │
│  │  │ • Session affinity         • Failover handling                  │ │    │
│  │  └─────────────────────────────────────────────────────────────────┘ │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                   │                                         │
│                    ┌───────────────┼───────────────┐                        │
│                    │               │               │                        │
│                    ▼               ▼               ▼                        │
│            ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                  │
│            │  Write      │ │  Read       │ │  Batch      │                  │
│            │  Optimized  │ │  Optimized  │ │  Processing │                  │
│            └─────────────┘ └─────────────┘ └─────────────┘                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            API LAYER (Rust/Axum)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                       Axum Web Server 🚀                            │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ POST /v1/namespaces/{namespace}/upsert                              │    │
│  │ POST /v1/namespaces/{namespace}/upsert-columns                      │    │
│  │ PATCH /v1/namespaces/{namespace}/update                             │    │
│  │ PATCH /v1/namespaces/{namespace}/update-columns                     │    │
│  │ DELETE /v1/namespaces/{namespace}/batch-delete                      │    │
│  │ POST /v1/namespaces/{namespace}/conditional-upsert                  │    │
│  │ PATCH /v1/namespaces/{namespace}/conditional-update                 │    │
│  │ DELETE /v1/namespaces/{namespace}/conditional-delete                │    │
│  │ DELETE /v1/namespaces/{namespace}/filter-delete                     │    │
│  │ POST /v1/namespaces/{namespace}/configure-metric                    │    │
│  │ POST/PUT /v1/namespaces/{namespace}/schema                          │    │
│  │ POST/PUT /v1/namespaces/{namespace}/encryption                      │    │
│  │ POST /v1/namespaces/{namespace}/copy                                │    │
│  │                                                                     │    │
│  │ Features:                                                           │    │
│  │ • Async request handling     • Rate limiting                        │    │
│  │ • Request validation         • Health checks                        │    │
│  │ • Error handling                                                    │    │
│  │ • Logging & tracing                                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                   │                                         │
└───────────────────────────────────┼─────────────────────────────────────────┘
                                   │
                                   ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                         EMBEDDING LAYER (FastEmbedding)                    │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ╔═══════════════════════════════════════════════════════════════════════╗ │
│  ║                    FastEmbedding Service                              ║ │
│  ╠═══════════════════════════════════════════════════════════════════════╣ │
│  ║                                                                       ║ │
│  ║  ┌─────────────────────┐    ┌─────────────────────┐                   ║ │
│  ║  │ Text Preprocessing  │───▶│ Vector Generation   │                  ║ │
│  ║  │ • Tokenization      │    │ • Model Inference   │                   ║ │
│  ║  │ • Normalization     │    │ • Dimensionality    │                   ║ │
│  ║  │ • Truncation        │    │ • Normalization     │                   ║ │
│  ║  └─────────────────────┘    └─────────────────────┘                   ║ │
│  ║                                      │                                ║ │
│  ║                                      ▼                                ║ │
│  ║  ┌─────────────────────────────────────────────────────────────────┐  ║ │
│  ║  │                   Batch Processing Engine                       │  ║ │
│  ║  │ • Optimal batch size: 32                                        │  ║ │
│  ║  │ • Dynamic batching based on load                                │  ║ │
│  ║  │ • SIMD acceleration                                             │  ║ │
│  ║  │ • Multi-threading support                                       │  ║ │
│  ║  └─────────────────────────────────────────────────────────────────┘  ║ │
│  ╚═══════════════════════════════════════════════════════════════════════╝ │
│                                   │                                        │
└───────────────────────────────────┼────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         RUST FFI LAYER (Bindings)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────┐       ┌───────────────────────┐                  │
│  │   Safe Rust Wrapper   │       │   Memory Management   │                  │
│  ├───────────────────────┤       ├───────────────────────┤                  │
│  │ • Error handling      │       │ • RAII patterns       │                  │
│  │ • Type safety         │       │ • Buffer management   │                  │
│  │ • Null safety         │       │ • Ownership transfer  │                  │
│  │ • Thread safety       │       │ • Resource cleanup    │                  │
│  └───────────┬───────────┘       └───────────┬───────────┘                  │
│              │                               │                              │
│              └───────────────────┬───────────┘                              │
│                                  │                                          │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                       FFI Function Declarations                        │ │
│  │                                                                        │ │
│  │  extern "C" {                                                          │ │
│  │      fn SPFresh_Create(...) -> *mut SPFreshIndex;                      │ │
│  │      fn SPFresh_AddBatch(...) -> i32;                                  │ │
│  │      fn SPFresh_Search(...) -> i32;                                    │ │
│  │      fn SPFresh_Delete(...) -> i32;                                    │ │
│  │      fn SPFresh_Destroy(...);                                          │ │
│  │  }                                                                     │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                  │                                          │
└──────────────────────────────────┼──────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         C++ INTERFACE LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                       C API Implementation                            │  │
│  │                                                                       │  │
│  │   C++ implementation (in spfresh_c_api.cpp)                           │  │                                                           
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                  │                                          │
└──────────────────────────────────┼──────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SPFRESH CORE (C++)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                       SPFresh Update Layer                             │ │
│  │                                                                        │ │
│  │  ┌─────────────────────┐      ┌─────────────────────┐                 │ │
│  │  │   In-Memory Buffer  │      │   LIRE Rebalancer   │                 │ │
│  │  │ (Memtable)          │────▶│                     │                 │ │
│  │  └─────────────────────┘      └─────────────────────┘                 │ │
│  │                                          │                             │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                             │                               │
│                                             ▼                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                       SPANN Index Layer                                │ │
│  │                                                                        │ │
│  │  ┌─────────────────────┐      ┌─────────────────────┐                 │ │
│  │  │   Centroid Index    │      │   Posting Lists     │                 │ │
│  │  │   (In-Memory)       │─────▶│   (On-Disk)         │                 │ │
│  │  └─────────────────────┘      └─────────────────────┘                 │ │
│  │                                                                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                             │                               │
│                                             ▼                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                       SPTAG Base Layer                                │ │
│  │                                                                       │ │
│  │  ┌─────────────────────┐      ┌─────────────────────┐                 │ │
│  │  │   Vector Index      │      │   Distance Calc     │                 │ │
│  │  │   Algorithms        │────▶│   Methods           │                │ │
│  │  └─────────────────────┘      └─────────────────────┘                 │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                         STORAGE LAYER (GCP)                                │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ╔═════════════════════════════════════════════════════════════════════╗   │
│  ║                    GCP Vector Storage Architecture                  ║   │
│  ╠═════════════════════════════════════════════════════════════════════╣   │
│  ║                                                                     ║   │
│  ║  ┌────────────────────┬─────────────────────────────────────────┐   ║   │
│  ║  │   Storage Type     │            Characteristics              │   ║   │
│  ║  ├────────────────────┼─────────────────────────────────────────┤   ║   │
│  ║  │ Memory (RAM)       │ • Centroid index                        │   ║   │
│  ║  │                    │ • Hot vectors                           │   ║   │
│  ║  │                    │ • Update buffer                         │   ║   │
│  ║  ├────────────────────┼─────────────────────────────────────────┤   ║   │
│  ║  │ Cloud Storage      │ • Vector data files                     │   ║   │
│  ║  │                    │ • WAL (Write-Ahead Log)                 │   ║   │
│  ║  │                    │ • Durable storage                       │   ║   │
│  ║  ├────────────────────┼─────────────────────────────────────────┤   ║   │
│  ║  │ Persistent Disk    │ • Posting lists                         │   ║   │
│  ║  │                    │ • SSD performance                       │   ║   │
│  ║  │                    │ • Optimized for random access           │   ║   │
│  ║  └──────────────────────────────────────────────────────────────┘   ║   │
│  ║                                                                     ║   │
│  ║  GCP Storage Strategy:                                              ║   │
│  ║  • Cloud Storage for durability and scalability                     ║   │
│  ║  • Persistent Disk for performance-critical components              ║   │
│  ║  • Memory cache for frequently accessed vectors                     ║   │
│  ║  • Regional redundancy for high availability                        ║   │
│  ║  • Object lifecycle management for cost optimization                ║   │
│  ╚═════════════════════════════════════════════════════════════════════╝   │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

## Complete Data Flow Journey

```
Client Application                          SPFresh-Rust System
─────────────────                           ────────────────────────────────────────────────
   ┌─────────────┐                          ┌──────────────────────────────────────────────┐
   │   Client    │                          │                  API LAYER                   │
   │   Request   │                          │                                              │
   └──────┬──────┘                          │  ┌────────────────────────────────┐          │
          │                                 │  │      Request Processing        │          │
          ▼                                 │  │                                │          │
   ┌─────────────┐     HTTP Request         │  │  • Parse JSON                  │          │
   │ JSON Payload│  ───────────────────────▶│  │  • Extract parameters          │          │
   │             │                          │  │  • Log request with trace ID   │          │
   └─────────────┘                          │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            └────────────────────┼─────────────────────────┘
                                                                 │
                                                                 ▼
                                            ┌──────────────────────────────────────────────┐
                                            │              EMBEDDING LAYER                 │
                                            │                                              │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      Input Type Check          │          │
                                            │  │                                │          │
                                            │  │  • Text or Vector?             │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            │                    ├─────────────┐           │
                                            │                    │             │           │
                                            │                    ▼             ▼           │
                                            │  ┌────────────────────┐ ┌────────────────┐   │
                                            │  │   FastEmbedding    │ │ Vector Input   │   │
                                            │  │   (Rust Library)   │ │                │   │
                                            │  │ • Tokenization     │ │ • Use provided │   │
                                            │  │ • Neural embedding │ │   vectors      │   │
                                            │  │ • Generate vectors │ │                │   │
                                            │  └─────────┬──────────┘ └────────┬───────┘   │
                                            │            │                     │           │
                                            │            └──────────┬──────────┘           │
                                            │                       │                      │
                                            │                       ▼                      │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      Vector Processing         │          │
                                            │  │                                │          │
                                            │  │  • Normalize vectors           │          │
                                            │  │  • Format for SPFresh          │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            └────────────────────┼─────────────────────────┘
                                                                 │
                                                                 ▼
                                            ┌──────────────────────────────────────────────┐
                                            │                 FFI LAYER                    │
                                            │                                              │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      Memory Management         │          │
                                            │  │                                │          │
                                            │  │  • Allocate buffers            │          │
                                            │  │  • Convert Rust → C types      │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            │                    ▼                         │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      FFI Function Calls        │          │
                                            │  │                                │          │
                                            │  │  • Call C++ functions          │          │
                                            │  │  • Handle errors               │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            └────────────────────┼─────────────────────────┘
                                                                 │
                                                                 ▼
                                            ┌──────────────────────────────────────────────┐
                                            │              C++ INTERFACE                   │
                                            │                                              │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      C API Implementation      │          │
                                            │  │                                │          │
                                            │  │  • Convert C → C++ types       │          │
                                            │  │  • Exception handling          │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            └────────────────────┼─────────────────────────┘
                                                                 │
                                                                 ▼
                                            ┌──────────────────────────────────────────────┐
                                            │              SPFRESH CORE                    │
                                            │                                              │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      SPFresh Update Layer      │          │
                                            │  │                                │          │
                                            │  │  • In-memory buffer            │          │
                                            │  │  • LIRE Rebalancer             │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            │                    ▼                         │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      SPANN Index Layer         │          │
                                            │  │                                │          │
                                            │  │  • Centroid index (memory)     │          │
                                            │  │  • Posting lists (disk)        │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            │                    ▼                         │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      SPTAG Base Layer          │          │
                                            │  │                                │          │
                                            │  │  • Vector algorithms           │          │
                                            │  │  • Distance calculations       │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            └────────────────────┼─────────────────────────┘
                                                                 │
                                                                 ▼
                                            ┌──────────────────────────────────────────────┐
                                            │              STORAGE LAYER (GCP)             │
                                            │                                              │
                                            │  ┌────────────────┐   ┌─────────────────┐    │
                                            │  │ Cloud Storage  │   │ Persistent Disk │    │
                                            │  │ • WAL entries  │   │ • Posting lists │    │
                                            │  │ • Vector data  │   │ • SSD access    │    │
                                            │  └────────┬───────┘   └────────┬────────┘    │
                                            │           │                    │             │
                                            │           └────────┬───────────┘             │
                                            │                    │                         │
                                            │                    ▼                         │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      Storage Management        │          │
                                            │  │                                │          │
                                            │  │  • Durability guarantees       │          │
                                            │  │  • Replication                 │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            └────────────────────┼─────────────────────────┘
                                                                 │
                                                                 ▼
                                            ┌──────────────────────────────────────────────┐
                                            │              RESPONSE HANDLING               │
                                            │                                              │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      Result Processing         │          │
                                            │  │                                │          │
                                            │  │  • Format JSON response        │          │
                                            │  │  • Add metadata                │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            └────────────────────┼─────────────────────────┘
                                                                 │
   ┌─────────────┐                                               │
   │   Client    │                                               │
   │  Response   │◀────────────────────────────────────────────────
   └─────────────┘
```

```

Client Application                          SPFresh-Rust System
─────────────────                           ────────────────────────────────────────────────
┌─────────────┐                          ┌──────────────────────────────────────────────┐
│   Client    │                          │                  API LAYER                   │
│   Query     │                          │                                              │
└──────┬──────┘                          │  ┌────────────────────────────────┐          │
       │                                 │  │      Query Processing          │          │
       ▼                                 │  │                                │          │
┌─────────────┐     HTTP Request         │  │  • Parse query parameters      │          │
│ Query JSON  │  ───────────────────────▶│  │  • Validate query format       │          │
│ Parameters  │                          │  │  • Set query options           │          │
└─────────────┘                          │  └─────────────────┬──────────────┘          │
                                         │                    │                         │
                                         └────────────────────┼─────────────────────────┘
                                                              │
                                                              ▼
                                            ┌──────────────────────────────────────────────┐
                                            │              QUERY PREPARATION               │
                                            │                                              │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      Query Vector Creation     │          │
                                            │  │                                │          │
                                            │  │  • Convert text to vector      │          │
                                            │  │  • Or use provided vector      │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            │                    ▼                         │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      Query Parameters          │          │
                                            │  │                                │          │
                                            │  │  • K nearest neighbors         │          │
                                            │  │  • Distance threshold          │          │
                                            │  │  • Filter conditions           │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            └────────────────────┼─────────────────────────┘
                                                                │
                                                                ▼
                                            ┌──────────────────────────────────────────────┐
                                            │                 FFI LAYER                    │
                                            │                                              │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      Query FFI Handling        │          │
                                            │  │                                │          │
                                            │  │  • Convert query parameters    │          │
                                            │  │  • Prepare memory buffers      │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            └────────────────────┼─────────────────────────┘
                                                                │
                                                                ▼
                                            ┌──────────────────────────────────────────────┐
                                            │              SPFRESH SEARCH                  │
                                            │                                              │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      Query Routing             │          │
                                            │  │                                │          │
                                            │  │  • Select appropriate index    │          │
                                            │  │  • Apply region-based routing  │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            │                    ▼                         │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      Cache Lookup              │          │
                                            │  │                                │          │
                                            │  │  • Check query cache           │          │
                                            │  │  • Return if cache hit         │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            │                    ▼                         │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      SPANN Search Algorithm    │          │
                                            │  │                                │          │
                                            │  │  • Find nearest centroids      │          │
                                            │  │  • Retrieve posting lists      │          │
                                            │  │  • Calculate distances         │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            └────────────────────┼─────────────────────────┘
                                                                │
                                                                ▼
                                            ┌──────────────────────────────────────────────┐
                                            │              STORAGE ACCESS                  │
                                            │                                              │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      Posting List Retrieval    │          │
                                            │  │                                │          │
                                            │  │  • Access disk/cloud storage   │          │
                                            │  │  • Load posting lists          │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            │                    ▼                         │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      Vector Data Access        │          │
                                            │  │                                │          │
                                            │  │  • Retrieve vector data        │          │
                                            │  │  • Apply filters               │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            └────────────────────┼─────────────────────────┘
                                                                │
                                                                ▼
                                            ┌──────────────────────────────────────────────┐
                                            │              RESULT PROCESSING               │
                                            │                                              │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      Result Ranking            │          │
                                            │  │                                │          │
                                            │  │  • Sort by distance            │          │
                                            │  │  • Apply post-filters          │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            │                    ▼                         │
                                            │  ┌────────────────────────────────┐          │
                                            │  │      Result Formatting         │          │
                                            │  │                                │          │
                                            │  │  • Format JSON response        │          │
                                            │  │  • Add metadata and scores     │          │
                                            │  │  • Cache results if needed     │          │
                                            │  └─────────────────┬──────────────┘          │
                                            │                    │                         │
                                            └────────────────────┼─────────────────────────┘
                                                                 │
┌─────────────┐                                                  │                                
│   Query     │                                                  │                                    
│  Results    │◀────────────────────────────────────────────────┘                                     
└─────────────┘                            

```
## Details Data Flow Journey (API)

### Vector Upsert Flow

```
Client Application                        SPFresh-Rust System
─────────────────                         ────────────────────────────────────────────────
┌─────────────┐                           ┌──────────────────────────────────────────────┐
│   Client    │                           │                  API LAYER                   │
│   Request   │                           │                                              │
└──────┬──────┘                           │  ┌────────────────────────────────┐          │
       │                                  │  │      Request Processing        │          │
       ▼                                  │  │  • Parse JSON                 │          │
┌─────────────┐  HTTP Request              │  │  • Extract parameters         │          │
│ JSON Payload│ ────────────────────────▶ │  │  • Validate schema            │          │
│ (upsert)    │                           │  └─────────────────┬────────────┘          │
└─────────────┘                           │                    │                        │
                                          └────────────────────┼────────────────────────┘
                                                              │
                                                              ▼
                                          ┌──────────────────────────────────────────────┐
                                          │              EMBEDDING LAYER                 │
                                          │                                              │
                                          │  ┌────────────────────────────────┐          │
                                          │  │      Input Type Check          │          │
                                          │  │  • Text or Vector?             │          │
                                          │  └─────────────────┬──────────────┘          │
                                          │                    │                        │
                                          │                    ▼                        │
                                          │  ┌──────────────────────────────┐            │
                                          │  │   FastEmbedding (Rust)      │            │
                                          │  │  • Tokenization             │            │
                                          │  │  • Neural embedding         │            │
                                          │  │  • Generate vectors         │            │
                                          │  └─────────────┬───────────────┘            │
                                          │                │                            │
                                          │                ▼                            │
                                          │  ┌──────────────────────────────┐            │
                                          │  │   Vector Processing         │            │
                                          │  │  • Normalize vectors        │            │
                                          │  │  • Format for SPFresh       │            │
                                          │  └─────────────────┬───────────┘            │
                                          │                    │                        │
                                          └────────────────────┼────────────────────────┘
                                                              │
                                                              ▼
                                          ┌──────────────────────────────────────────────┐
                                          │                 FFI LAYER                    │
                                          │  • Allocate buffers                          │
                                          │  • Convert Rust → C types                    │
                                          │  • Call SPFresh_AddBatch                     │
                                          │  • Handle errors                             │
                                          └──────────────────────────────────────────────┘
                                                              │
                                                              ▼
                                          ┌──────────────────────────────────────────────┐
                                          │              C++ INTERFACE                   │
                                          │  • Convert C → C++ types                     │
                                          │  • Exception handling                        │
                                          └──────────────────────────────────────────────┘
                                                              │
                                                              ▼
                                          ┌──────────────────────────────────────────────┐
                                          │              SPFRESH CORE                    │
                                          │  • Add to in-memory buffer                   │
                                          │  • Write to WAL                              │
                                          │  • Update centroid index                     │
                                          │  • Schedule rebalancing                      │
                                          └──────────────────────────────────────────────┘
                                                              │
                                                              ▼
                                          ┌──────────────────────────────────────────────┐
                                          │              STORAGE LAYER (GCP)             │
                                          │  • WAL entries (namespace/wal/*.log)         │
                                          │  • Vector data (namespace/vectors/*)         │
                                          │  • Fulltext indices (namespace/fulltext/*)   │
                                          │  • Metadata (namespace/metadata/*)           │
                                          └──────────────────────────────────────────────┘
                                                              │
                                                              ▼
                                          ┌──────────────────────────────────────────────┐
                                          │              RESPONSE HANDLING               │
                                          │  • Format JSON response                      │
                                          │  • Add operation status                      │
                                          └──────────────────────────────────────────────┘
                                                              │
┌─────────────┐                                               │
│   Client    │                                               │
│  Response   │◀──────────────────────────────────────────────┘
└─────────────┘
```

### Vector Update Flow

```
Client Application                          SPFresh-Rust System
─────────────────                           ────────────────────────────────────────────────
┌─────────────┐                          ┌──────────────────────────────────────────────┐
│   Client    │                          │                  API LAYER                   │
│   Request   │                          │                                              │
└──────┬──────┘                          │  ┌────────────────────────────────┐          │
       │                                 │  │      Request Processing        │          │
       ▼                                 │  │                                │          │
┌─────────────┐     HTTP Request         │  │  • Parse JSON                  │          │
│ JSON Payload│  ───────────────────────▶│  │  • Extract IDs & fields       │          │
│ (update)    │                          │  │  • Validate schema             │          │
└─────────────┘                          │  └─────────────────┬──────────────┘          │
                                         │                    │                         │
                                         └────────────────────┼─────────────────────────┘
                                                             │
                                                             ▼
                                         ┌──────────────────────────────────────────────┐
                                         │                 FFI LAYER                    │
                                         │                                              │
                                         │  ┌────────────────────────────────┐          │
                                         │  │      Memory Management         │          │
                                         │  │                                │          │
                                         │  │  • Allocate buffers            │          │
                                         │  │  • Convert Rust → C types      │          │
                                         │  └─────────────────┬──────────────┘          │
                                         │                    │                         │
                                         │                    ▼                         │
                                         │  ┌────────────────────────────────┐          │
                                         │  │      FFI Function Calls        │          │
                                         │  │                                │          │
                                         │  │  • Call SPFresh_Update         │          │
                                         │  │  • Handle errors               │          │
                                         │  └─────────────────┬──────────────┘          │
                                         │                    │                         │
                                         └────────────────────┼─────────────────────────┘
                                                             │
                                                             ▼
                                         ┌──────────────────────────────────────────────┐
                                         │              C++ INTERFACE                   │
                                         │                                              │
                                         │  ┌────────────────────────────────┐          │
                                         │  │      C API Implementation      │          │
                                         │  │                                │          │
                                         │  │  • Convert C → C++ types       │          │
                                         │  │  • Exception handling          │          │
                                         │  └─────────────────┬──────────────┘          │
                                         │                    │                         │
                                         └────────────────────┼─────────────────────────┘
                                                             │
                                                             ▼
                                         ┌──────────────────────────────────────────────┐
                                         │              SPFRESH CORE                    │
                                         │                                              │
                                         │  ┌────────────────────────────────┐          │
                                         │  │      Document Lookup           │          │
                                         │  │                                │          │
                                         │  │  • Find documents by ID        │          │
                                         │  │  • Verify existence            │          │
                                         │  └─────────────────┬──────────────┘          │
                                         │                    │                         │
                                         │                    ▼                         │
                                         │  ┌────────────────────────────────┐          │
                                         │  │      Metadata Update           │          │
                                         │  │                                │          │
                                         │  │  • Update metadata fields      │          │
                                         │  │  • Write to WAL                │          │
                                         │  └─────────────────┬──────────────┘          │
                                         │                    │                         │
                                         └────────────────────┼─────────────────────────┘
                                                             │
                                                             ▼
                                         ┌──────────────────────────────────────────────┐
                                         │              STORAGE LAYER (GCP)             │
                                         │                                              │
                                         │  ┌────────────────┐   ┌─────────────────┐    │
                                         │  │ Cloud Storage  │   │ Persistent Disk │    │
                                         │  │ • WAL entries  │   │ • Metadata      │    │
                                         │  │ • Durability   │   │ • Updates       │    │
                                         │  └────────┬───────┘   └────────┬────────┘    │
                                         │           │                    │             │
                                         │           └────────┬───────────┘             │
                                         │                    │                         │
                                         └────────────────────┼─────────────────────────┘
                                                             │
                                                             ▼
                                         ┌──────────────────────────────────────────────┐
                                         │              RESPONSE HANDLING               │
                                         │                                              │
                                         │  ┌────────────────────────────────┐          │
                                         │  │      Result Processing         │          │
                                         │  │                                │          │
                                         │  │  • Format JSON response        │          │
                                         │  │  • Add operation status        │          │
                                         │  └─────────────────┬──────────────┘          │
                                         │                    │                         │
                                         └────────────────────┼─────────────────────────┘
                                                             │
┌─────────────┐                                              │
│   Client    │                                              │
│  Response   │◀─────────────────────────────────────────────┘
└─────────────┘
```


###  Post-Write Processing

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Post-Write Processing                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. Success Response                                                │
│  {                                                                  │
│    "status": "ok",                                                 │
│    "inserted": 3,                                                  │
│    "updated": 0,                                                   │
│    "deleted": 0,                                                   │
│    "errors": []                                                    │
│  }                                                                  │
│                                                                     │
│  2. Async Index Building Trigger                                    │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐         │
│  │ WAL Monitor │────▶│Index Queue  │────▶│Index Builder│         │
│  │  (Polling)  │     │  (In-Memory)│     │  (Workers)  │         │
│  └─────────────┘     └─────────────┘     └─────────────┘         │
│                                                                     │
│  3. Cache Invalidation                                              │
│  - Invalidate affected namespace cache entries                     │
│  - Update namespace metadata (doc count, last write time)          │
│  - Trigger pre-warming if configured                               │
└─────────────────────────────────────────────────────────────────────┘
```

## SPFresh reverse index architecture

```
┌───────────────────────┐
│                       │
│    USER SEARCH        │
│    REQUEST            │
│                       │
└──────────┬────────────┘
           │
           ▼
┌──────────────────────┐
│                      │
│   API LAYER          │
│   (Rust/Axum)        │
│                      │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│                      │
│   QUERY PARSER       │
│                      │
└────────────┬─────────┘
             │
 ┌───────────────┬──────────────────┬─────────────────┐
 │               │                  │                 │
 ▼               ▼                  ▼                 ▼
┌───────────────────┐ ┌────────────────────┐ ┌───────────────────┐ ┌───────────────────┐
│ METADATA FILTER   │ │ VECTOR SIMILARITY  │ │ FULLTEXT SEARCH   │ │ PAGINATION &      │
│ PROCESSING        │ │ SEARCH             │ │ PROCESSING        │ │ SORTING           │
└────────┬──────────┘ └─────────┬──────────┘ └────────┬──────────┘ └────────┬──────────┘
         │                      │                     │                     │
         ▼                      ▼                     ▼                     │
┌───────────────────┐ ┌────────────────────┐ ┌───────────────────┐          │
│  METADATA INDEX   │ │  VECTOR INDEX      │ │  FULLTEXT INDEX   │          │
│                   │ │                    │ │                   │          │
│  Field → IDs      │ │  Centroid → IDs    │ │  Term → IDs      │          │
│                   │ │                    │ │                   │          │
│  category:        │ │  Centroid 1        │ │  "smartphone"     │          │
│  electronics      │ │  ↓                 │ │  ↓                │          │
│  ↓                │ │  [ID1, ID5, ID9]   │ │  [ID1, ID7]       │          │
│  [ID1, ID5, ID9]  │ │                    │ │                   │          │
│                   │ │  Centroid 2        │ │  "wireless"       │          │
│  price:           │ │  ↓                 │ │  ↓                │          │
│  range(0,100)     │ │  [ID2, ID7, ID8]   │ │  [ID5, ID9]       │          │
│  ↓                │ │                    │ │                   │          │
│  [ID2, ID7, ID8]  │ │                    │ │                   │          │
└────────┬──────────┘ └─────────┬──────────┘ └────────┬──────────┘          │
         │                      │                     │                     │
         └──────────┬───────────┴─────────────────────┘                     │
                    │                                                       │
                    ▼                                                       │
           ┌────────────────────┐                                           │
           │  RESULT CANDIDATE  │                                           │
           │  SET               │                                           │
           └────────┬───────────┘                                           │
                    │                                                       │
                    └─────────────────┬───────────────────────────────────┬─┘
                                      │                                   │
                                      ▼                                   │
                           ┌────────────────────┐                         │
                           │  ID MAPPING        │                         │
                           │                    │                         │
                           │  Vector ID → Meta  │                         │
                           │                    │                         │
                           │  ID1 → {title: "A",│                         │
                           │        category: "B"}                        │
                           │                    │                         │
                           │  ID2 → {title: "C",│                         │
                           │        category: "D"}                        │
                           │                    │                         │
                           └────────┬───────────┘                         │
                                    │                                     │
                                    ▼                                     │
                           ┌────────────────────┐                         │
                           │                    │                         │
                           │  FINAL RESULTS     │◀────────────────────────┘
                           │                    │
                           └────────┬───────────┘
                                    │
                                    ▼
                           ┌────────────────────┐
                           │                    │
                           │  USER RESPONSE     │
                           │                    │
                           └────────────────────┘
```


## Webhook Interfaces 

### Upsert Operation
```
POST /v1/namespaces/product-catalog/upsert
{
  "upsert_rows": [
    {
      "id": "product-123",
      "text": "Wireless Smartphone Charger. Fast charging wireless pad for smartphones. Compatible with all Qi-enabled devices.",
      "metadata": {
        "title": "Wireless Smartphone Charger",
        "description": "Fast charging wireless pad for smartphones",
        "category": "electronics",
        "price": 29.99,
        "tags": ["wireless", "charging", "smartphone"],
        "in_stock": true,
        "created_at": "2025-06-15T10:30:00Z"
      }
    },
    {
      "id": "product-456",
      "text": "Bluetooth Headphones with noise cancellation. Over-ear design with premium audio quality and 20-hour battery life.",
      "metadata": {
        "title": "Bluetooth Headphones",
        "description": "Noise-cancelling over-ear headphones",
        "category": "electronics",
        "price": 89.99,
        "tags": ["bluetooth", "audio", "headphones"],
        "in_stock": true,
        "created_at": "2025-06-14T09:15:00Z"
      }
    }
  ]
}

Response:
{
  "status": "ok",
  "inserted": 2,
  "updated": 0,
  "errors": [],
  "operation_id": "op-2025-07-23-abcdef123456"
}
```

### Update Operation
```
PATCH /v1/namespaces/product-catalog/update
{
  "patch_rows": [
    {
      "id": "product-123",
      "metadata": {
        "price": 24.99,
        "in_stock": false,
        "updated_at": "2025-07-23T14:25:00Z"
      }
    }
  ]
}

Response:
{
  "status": "ok",
  "inserted": 0,
  "updated": 1,
  "errors": [],
  "operation_id": "op-2025-07-23-ghijkl789012"
}
```

### Conditional Upsert Operation
```
POST /v1/namespaces/product-catalog/conditional-upsert
{
  "upsert_rows": [
    {
      "id": "product-789",
      "text": "Smart Watch with fitness tracking features. Includes heart rate monitor, step counter, and sleep tracking.",
      "metadata": {
        "title": "Smart Watch",
        "description": "Fitness tracking smartwatch with heart rate monitor",
        "category": "wearables",
        "price": 149.99,
        "tags": ["smartwatch", "fitness", "wearable"],
        "in_stock": true
      }
    }
  ],
  "condition": {
    "field": "price",
    "operator": "gt",
    "value": 100
  }
}

Response:
{
  "status": "ok",
  "inserted": 1,
  "updated": 0,
  "condition_met": true,
  "errors": [],
  "operation_id": "op-2025-07-23-mnopqr345678"
}
```


### Batch Delete Operation
```
DELETE /v1/namespaces/product-catalog/batch-delete
{
  "deletes": ["product-123", "product-456"]
}

Response:
{
  "status": "ok",
  "deleted": 2,
  "errors": [],
  "operation_id": "op-2025-07-23-stuvwx901234"
}
```

### Search Operation (Text-Based)
```
POST /v1/namespaces/product-catalog/search
{
  "text": "wireless charging for smartphones",
  "filter": {
    "category": "electronics",
    "price": {"$lt": 50},
    "in_stock": true
  },
  "top_k": 5,
  "include_metadata": true,
  "include_vectors": false
}

Response:
{
  "status": "ok",
  "matches": [
    {
      "id": "product-123",
      "score": 0.92,
      "metadata": {
        "title": "Wireless Smartphone Charger",
        "description": "Fast charging wireless pad for smartphones",
        "category": "electronics",
        "price": 24.99,
        "tags": ["wireless", "charging", "smartphone"],
        "in_stock": true
      }
    },
    {
      "id": "product-789",
      "score": 0.78,
      "metadata": {
        "title": "Smart Watch",
        "description": "Fitness tracking smartwatch with heart rate monitor",
        "category": "wearables",
        "price": 149.99,
        "tags": ["smartwatch", "fitness", "wearable"],
        "in_stock": true
      }
    }
  ],
  "found": 2,
  "search_time_ms": 15
}
```

### Batch Delete Operation
```
DELETE /v1/namespaces/product-catalog/batch-delete
{
  "deletes": ["product-123", "product-456"]
}

Response:
{
  "status": "ok",
  "deleted": 2,
  "errors": [],
  "operation_id": "op-2025-07-23-stuvwx901234"
}
```


### Insert Webhook

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      SPFresh-Rust Insert API with Embedding                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Endpoint:                                                                  │
│  POST /v1/namespaces/{namespace}/upsert                                     │
│                                                                             │
│  Request Body (with text for embedding):                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ {                                                                   │    │
│  │   "upsert_rows": [                                                  │    │
│  │     {"id": 1, "text": "Red shoes with leather sole", "score": 5},   │    │
│  │     {"id": 2, "text": "Blue cotton t-shirt", "score": 4}            │    │
│  │   ]                                                                 │    │
│  │ }                                                                   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  Response (Success):                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ {                                                                   │    │
│  │   "status": "ok",                                                   │    │
│  │   "inserted": 2,                                                    │    │
│  │   "errors": []                                                      │    │
│  │ }                                                                   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

##  Object Storage Backend
```
┌───────────────────────────────────────────────────────────────────────────┐
│                       SPFRESH ARCHITECTURE WITH                           │
│                       OBJECT STORAGE BACKEND                              │
└───────────────────────────────────────────────────────────────────────────┘
                                    │
                 ┌─────────────────┬┴┬─────────────────┐
                 │                 │ │                 │
                 ▼                 ▼ ▼                 ▼
┌───────────────────────┐ ┌───────────────────┐ ┌───────────────────────┐
│  QUERY PROCESSING     │ │  INDEX MANAGEMENT  │ │  WRITE OPERATIONS    │
│                       │ │                    │ │                      │
│  • Search             │ │  • Rebalancing     │ │  • Upsert           │
│  • Filter             │ │  • Optimization    │ │  • Update           │
│  • Fulltext           │ │  • Compression     │ │  • Delete           │
└─────────┬─────────────┘ └────────┬──────────┘ └──────────┬───────────┘
          │                        │                       │
          └────────────────────────┼───────────────────────┘
                                   │
                                   ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                       IN-MEMORY COMPONENTS                                │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐│
│  │  Centroid Index     │  │  Recent Vectors     │  │  Metadata Cache     ││
│  │  (HNSW/IVF)         │  │  (Write Buffer)     │  │  (LRU Cache)        ││
│  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘│
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                       ROCKSDB LAYER                                       │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐│
│  │  Metadata Index     │  │  Posting Lists      │  │  WAL Buffer         ││
│  │  (Key-Value Store)  │  │  (SST Files)        │  │  (Log Files)        ││
│  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘│
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                       OBJECT STORAGE BACKEND                              │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  Object Storage (GCS/S3/Azure)                                      │  │
│  │  ├── namespace-1/                                                   │  │
│  │  │   ├── wal/                                                       │  │
│  │  │   │   ├── entry-001.log                                          │  │
│  │  │   │   ├── entry-002.log                                          │  │
│  │  │   │   └── ...                                                    │  │
│  │  │   ├── vectors/                                                   │  │
│  │  │   │   ├── spfresh-index/                                         │  │
│  │  │   │   └── clusters/                                              │  │
│  │  │   ├── fulltext/                                                  │  │
│  │  │   │   └── bm25-index/                                            │  │
│  │  │   └── metadata/                                                  │  │
│  │  │       └── exact-indexes/                                         │  │
│  │  ├── namespace-2/                                                   │  │
│  │  └── ...                                                            │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```
### Write Flow (Upsert/Update/Delete)
```
┌───────────────┐     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│ API Request   │────▶│ Write Buffer  │────▶│ WAL Buffer    │────▶│ Object Storage│
│ (Upsert)      │     │ (In-Memory)   │     │ (RocksDB)     │     │ (wal/*.log)   │
└───────────────┘     └───────────────┘     └───────────────┘     └───────────────┘
                             │                                            ▲
                             │                                            │
                             ▼                                            │
                      ┌───────────────┐     ┌───────────────┐             │
                      │ Index Update  │────▶│ Background    │─────────────┘
                      │ (Async)       │     │ Flush         │
                      └───────────────┘     └───────────────┘
```

### Read Flow (Search/Query)
```
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│ API Request   │────▶│ Query Parser  │────▶│ In-Memory     │
│ (Search)      │     │               │     │ Indices       │
└───────────────┘     └───────────────┘     └───────┬───────┘
                                                   │
                                                   │ Cache Miss
                                                   ▼
                                            ┌───────────────┐
                                            │ RocksDB       │
                                            │ Indices       │
                                            └───────┬───────┘
                                                   │
                                                   │ Not Found
                                                   ▼
                                            ┌───────────────┐
                                            │ Object Storage│
                                            │ Fetch         │
                                            └───────────────┘
```



## โครงสร้างการเก็บข้อมูล 

```
┌─────────────────────────────────────────────────────────────────────────────┐
│        SPFresh Data Storage Location & Format (Native use RocksDB)          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  เมื่อคุณใส่ embedding ข้อมูลจะไปเก็บที่:                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ Path: ตามที่ตั้งใน m_KVPath configuration                               │    │
│  │                                                                     │    │
│  │ ตัวอย่าง:                                                             │    │
│  │ options.m_KVPath = "/data/spfresh/rocksdb";                         │    │
│  │                                                                     │    │
│  │ ข้อมูลจะถูกเก็บใน directory นี้:                                          │    │
│  │ /data/spfresh/rocksdb/                                              │    │
│  │ ├── 000003.log          # WAL file (ถ้าเปิด WAL)                      │    │
│  │ ├── 000004.sst          # SST files (sorted string tables)         │    │
│  │ ├── 000005.sst                                                     │    │
│  │ ├── 000006.blob         # Blob files (สำหรับ vector data)           │    │
│  │ ├── CURRENT             # Current manifest file                    │    │
│  │ ├── IDENTITY            # Database identity                        │    │
│  │ ├── LOCK                # Database lock file                       │    │
│  │ ├── MANIFEST-000001     # Metadata about SST files                 │    │
│  │ └── OPTIONS-000007      # RocksDB options                          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  รูปแบบการเก็บข้อมูล:                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ Key-Value Format:                                                   │    │
│  │                                                                     │    │
│  │ Key: SizeType (4 bytes integer)                                     │    │
│  │ │                                                                   │    │
│  │ │ ┌─────────────────────────────────────────────────────────────┐   │    │
│  │ └▶│ Vector ID (เช่น 1, 2, 3, ...)                                │   │    │
│  │   └─────────────────────────────────────────────────────────────┘   │    │
│  │                                                                     │    │
│  │ Value: Binary Data (vector + metadata)                              │    │
│  │ │                                                                   │    │
│  │ │ ┌─────────────────────────────────────────────────────────────┐   │    │
│  │ └▶│ Vector Data: [0.1, 0.2, 0.3, ...] (float array)             │   │    │
│  │   │ Metadata: attributes, timestamps, etc.                      │   │    │
│  │   └─────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  File Structure Details:                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ SST Files (.sst):                                                   │    │
│  │ • ขนาด: 128MB base, 256MB, 512MB, 1GB (multiplier = 2)              │    │
│  │ • เก็บ key-value pairs ที่ sorted                                      │    │
│  │ • มี Bloom filter สำหรับ fast lookup                                  │    │
│  │ • Compressed ด้วย LZ4/ZSTD                                           │    │
│  │                                                                     │    │
│  │ Blob Files (.blob):                                                 │    │
│  │ • ขนาด: 8GB per file                                                │    │
│  │ • เก็บ vector data ที่ใหญ่กว่า 64 bytes                                 │    │
│  │ • ไม่มี compression (เพื่อความเร็ว)                                       │    │
│  │ • มี garbage collection                                              │    │
│  │                                                                     │    │
│  │ WAL Files (.log):                                                   │    │
│  │ • เก็บ write operations ก่อน commit                                   │    │
│  │ • ใช้สำหรับ crash recovery                                            │    │
│  │ • ถ้าปิด WAL จะไม่มีไฟล์นี้                                               │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  การทำงานของ RocksDB:                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 1. เมื่อใส่ embedding:                                                  │    │
│  │    • ข้อมูลเข้า MemTable (RAM) ก่อน                                     │    │
│  │    • เมื่อ MemTable เต็ม → flush เป็น SST file                           │    │
│  │    • Vector ใหญ่ → เก็บใน Blob file                                   │    │
│  │                                                                     │    │
│  │ 2. Background Compaction:                                           │    │
│  │    • รวม SST files เก่า → SST files ใหม่                               │    │
│  │    • ลบข้อมูลซ้ำและข้อมูลที่ถูกลบ                                         │    │
│  │    • จัดเรียงข้อมูลให้เหมาะสำหรับการค้นหา                                  │    │
│  │                                                                     │    │
│  │ 3. การค้นหา:                                                         │    │
│  │    • ค้นหาใน MemTable ก่อน                                           │    │
│  │    • ใช้ Bloom filter ใน SST files                                   │    │
│  │    • ใช้ LRU cache (3GB) สำหรับข้อมูลที่ใช้บ่อย                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

ที่เก็บ: ใน directory ที่ตั้งใน m_KVPath (เช่น /data/spfresh/rocksdb/)

รูปแบบไฟล์:

SST files: เก็บ Vector ID → Vector Data mappings
Blob files: เก็บ vector embeddings ขนาดใหญ่
MANIFEST: ติดตาม SST files ทั้งหมด
CURRENT: ชี้ไปยัง MANIFEST ปัจจุบัน
OPTIONS: เก็บ configuration ที่ตั้งไว้
IDENTITY: unique ID ของ database
LOCK: ป้องกันการเปิดหลาย process
WAL files: ไม่มี (เพราะ SPFresh ปิดใช้งาน)

รูปแบบข้อมูล:

Key: Vector ID (4 bytes integer)
Value: Vector data + metadata (binary format)

การจัดการ:

Background compaction
Garbage collection
LRU cache (3GB)
Bloom filters

```




