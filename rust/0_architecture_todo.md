
```
  ┌───────────────────────────────────────────────────────┐
  │                 CLIENT APPLICATIONS                   │
  ├──────────────────────────────────┬────────────────────┤
  │         REST API Clients         │                    │
  │                                  │                    │
  │ ┌──────────┐  ┌──────────┐  ┌──────────┐              │
  │ │ Web App  │  │  Mobile  │  │ Desktop  │              │
  │ │ Frontend │  │   App    │  │   App    │              │
  │ │   🌐    │  │    📱    │  │    💻    │              │      
  │ └────┬─────┘  └────┬─────┘  └────┬─────┘              │
  │      │              │            │                    │
  │      │HTTP/JSON     │HTTP/JSON   │HTTP/JSON           │
  │      │              │            │                    │
  └──────────────────────────────────┬────────────────────┘
                                     │
                                     ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                           LOAD BALANCER LAYER                                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐    │
│  │                    GCP Load Balancer 🔄                              │    │
│  ├──────────────────────────────────────────────────────────────────────┤    │
│  │                                                                      │    │
│  │  ┌─────────────────────┐    ┌─────────────────────┐                  │    │
│  │  │   Health Checks     │    │   Traffic Routing   │                  │    │
│  │  │ • Service health    │    │ • Round robin       │                  │    │
│  │  │ • Response time     │    │ • Weighted routing  │                  │    │
│  │  │ • Error rates       │    │ • Geo-based routing │                  │    │
│  │  └─────────────────────┘    └─────────────────────┘                  │    │
│  │                                                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │    │
│  │  │                   Load Balancing Features                       │ │    │
│  │  │ • SSL termination           • Rate limiting                     │ │    │
│  │  │ • DDoS protection          • Request routing                    │ │    │
│  │  │ • Auto-scaling triggers    • Circuit breaker                    │ │    │
│  │  │ • Session affinity         • Failover handling                  │ │    │
│  │  └─────────────────────────────────────────────────────────────────┘ │    │
│  └──────────────────────────────────────────────────────────────────────┘    │
│                                   │                                          │
│                    ┌───────────────┼───────────────┐                         │
│                    │               │               │                         │
│                    ▼               ▼               ▼                         │
│            ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                   │
│            │  Write      │ │  Read       │ │  Batch      │                   │
│            │  Optimized  │ │  Optimized  │ │  Processing │                   │
│            └─────────────┘ └─────────────┘ └─────────────┘                   │
└──────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            API LAYER (Rust/Axum)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                       Axum Web Server 🚀                            │    │
│  ├─────────────────────────────────────────────────────────────────────┤    │
│  │ POST /v1/namespaces/{namespace}/upsert                              │    │
│  │ POST /v1/namespaces/{namespace}/upsert-columns                      │    │
│  │ PATCH /v1/namespaces/{namespace}/update                             │    │
│  │ PATCH /v1/namespaces/{namespace}/update-columns                     │    │
│  │ DELETE /v1/namespaces/{namespace}/batch-delete                      │    │
│  │ POST /v1/namespaces/{namespace}/conditional-upsert                  │    │
│  │ PATCH /v1/namespaces/{namespace}/conditional-update                 │    │
│  │ DELETE /v1/namespaces/{namespace}/conditional-delete                │    │
│  │ DELETE /v1/namespaces/{namespace}/filter-delete                     │    │
│  │ POST /v1/namespaces/{namespace}/configure-metric                    │    │
│  │ POST/PUT /v1/namespaces/{namespace}/schema                          │    │
│  │ POST/PUT /v1/namespaces/{namespace}/encryption                      │    │
│  │ POST /v1/namespaces/{namespace}/copy                                │    │
│  │                                                                     │    │
│  │ Features:                                                           │    │
│  │ • Async request handling     • Rate limiting                        │    │
│  │ • Request validation         • Health checks                        │    │
│  │ • Error handling                                                    │    │
│  │ • Logging & tracing                                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                   │                                         │
└───────────────────────────────────┼─────────────────────────────────────────┘
                                    │
                                    ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                         EMBEDDING LAYER (FastEmbedding)                    │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ╔═══════════════════════════════════════════════════════════════════════╗ │
│  ║                    FastEmbedding Service                              ║ │
│  ╠═══════════════════════════════════════════════════════════════════════╣ │
│  ║                                                                       ║ │
│  ║  ┌─────────────────────┐    ┌─────────────────────┐                   ║ │
│  ║  │ Text Preprocessing  │───▶│ Vector Generation   │                  ║ │
│  ║  │ • Tokenization      │    │ • Model Inference   │                   ║ │
│  ║  │ • Normalization     │    │ • Dimensionality    │                   ║ │
│  ║  │ • Truncation        │    │ • Normalization     │                   ║ │
│  ║  └─────────────────────┘    └─────────────────────┘                   ║ │
│  ║                                      │                                ║ │
│  ║                                      ▼                                ║ │
│  ║  ┌─────────────────────────────────────────────────────────────────┐  ║ │
│  ║  │                   Batch Processing Engine                       │  ║ │
│  ║  │ • Optimal batch size: 32                                        │  ║ │
│  ║  │ • Dynamic batching based on load                                │  ║ │
│  ║  │ • SIMD acceleration                                             │  ║ │
│  ║  │ • Multi-threading support                                       │  ║ │
│  ║  └─────────────────────────────────────────────────────────────────┘  ║ │
│  ╚═══════════════════════════════════════════════════════════════════════╝ │
│                                   │                                        │
└───────────────────────────────────┼────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         RUST FFI LAYER (Bindings)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────┐       ┌───────────────────────┐                  │
│  │   Safe Rust Wrapper   │       │   Memory Management   │                  │
│  ├───────────────────────┤       ├───────────────────────┤                  │
│  │ • Error handling      │       │ • RAII patterns       │                  │
│  │ • Type safety         │       │ • Buffer management   │                  │
│  │ • Null safety         │       │ • Ownership transfer  │                  │
│  │ • Thread safety       │       │ • Resource cleanup    │                  │
│  └───────────┬───────────┘       └───────────┬───────────┘                  │
│              │                               │                              │
│              └───────────────────┬───────────┘                              │
│                                  │                                          │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                       FFI Function Declarations                        │ │
│  │                                                                        │ │
│  │  extern "C" {                                                          │ │
│  │      fn SPFresh_Create(...) -> *mut SPFreshIndex;                      │ │
│  │      fn SPFresh_AddBatch(...) -> i32;                                  │ │
│  │      fn SPFresh_Search(...) -> i32;                                    │ │
│  │      fn SPFresh_Delete(...) -> i32;                                    │ │
│  │      fn SPFresh_Destroy(...);                                          │ │
│  │  }                                                                     │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                  │                                          │
└──────────────────────────────────┼──────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         C++ INTERFACE LAYER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                       C API Implementation                            │  │
│  │                                                                       │  │
│  │   C++ implementation (in spfresh_c_api.cpp)                           │  │                                                           
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                  │                                          │
└──────────────────────────────────┼──────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SPFRESH CORE (C++)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                       SPFresh Update Layer                             │ │
│  │                                                                        │ │
│  │  ┌─────────────────────┐      ┌─────────────────────┐                  │ │
│  │  │   In-Memory Buffer  │      │   LIRE Rebalancer   │                  │ │
│  │  │ (Memtable)          │────▶│                     │                  │ │
│  │  └─────────────────────┘      └─────────────────────┘                  │ │
│  │                                          │                             │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                             │                               │
│                                             ▼                               │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                       SPANN Index Layer                                │ │
│  │                                                                        │ │
│  │  ┌─────────────────────┐      ┌─────────────────────┐                  │ │
│  │  │   Centroid Index    │      │   Posting Lists     │                  │ │
│  │  │   (In-Memory)       │─────▶│   (On-Disk)         │                 │ │
│  │  └─────────────────────┘      └─────────────────────┘                  │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                             │                               │
│                                             ▼                               │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                       SPTAG Base Layer                                 │ │
│  │                                                                        │ │
│  │  ┌─────────────────────┐      ┌─────────────────────┐                  │ │
│  │  │   Vector Index      │      │   Distance Calc     │                  │ │
│  │  │   Algorithms        │────▶│   Methods           │                  │ │
│  │  └─────────────────────┘      └─────────────────────┘                  │ │
│  │                                                                        │ │
│  └────────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                         STORAGE LAYER (Trait-Based)                        │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│  ╔═════════════════════════════════════════════════════════════════════╗   │
│  ║                    Storage Abstraction Layer                        ║   │
│  ╠═════════════════════════════════════════════════════════════════════╣   │
│  ║                                                                     ║   │
│  ║  ┌─────────────────────────────────────────────────────────────┐    ║   │
│  ║  │                 StorageBackend Trait                        │    ║   │
│  ║  │                                                             │    ║   │
│  ║  │  • write() / read() / delete()                              │    ║   │
│  ║  │  • batch_write() / list_keys()                              │    ║   │
│  ║  │  • get_backend_type() / get_capabilities()                  │    ║   │
│  ║  └─────────────────────────────────────────────────────────────┘    ║   │
│  ║                                                                     ║   │
│  ╚═════════════════════════════════════════════════════════════════════╝   │
│                                    │                                       │
│                    ┌───────────────┼───────────────┐                       │
│                    │               │               │                       │
│                    ▼               ▼               ▼                       │
│  ┌─────────────────────┐ ┌─────────────────────┐ ┌─────────────────────┐   │
│  │   RocksDB Backend   │ │  Cloud Storage      │ │   Hybrid Backend    │   │
│  │                     │ │  Backend            │ │                     │   │
│  │  • Local SSD        │ │                     │ │  • Hot: RocksDB     │   │
│  │  • Fast access      │ │  • S3/GCS/Azure     │ │  • Cold: Cloud      │   │
│  │  • Limited scale    │ │  • Unlimited scale  │ │  • Smart routing    │   │
│  │  • Low latency      │ │  • Higher latency   │ │  • Cache mgmt       │   │
│  └─────────────────────┘ └─────────────────────┘ └─────────────────────┘   │
│                                    │                                       │
│                                    ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Storage Router & Manager                         │   │
│  │                                                                     │   │
│  │  ┌─────────────────────┐    ┌─────────────────────┐                 │   │
│  │  │   Configuration     │    │   Runtime Routing   │                 │   │
│  │  │   Management        │    │   Logic             │                 │   │
│  │  │                     │    │                     │                 │   │
│  │  │  • Backend selection│    │  • Data locality    │                 │   │
│  │  │  • Region mapping   │    │  • Load balancing   │                 │   │
│  │  │  • Failover rules   │    │  • Cache decisions  │                 │   │
│  │  └─────────────────────┘    └─────────────────────┘                 │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │                   Multi-Level Caching                       │    │   │
│  │  │                                                             │    │   │
│  │  │  • L1: In-memory (hot data)                                 │    │   │
│  │  │  • L2: Local disk (warm data)                               │    │   │
│  │  │  • L3: Distributed (TurboPuffer integration)                │    │   │
│  │  │  • Cache invalidation and consistency                       │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```
## เปรียบเทียบ Data Flow สําหรับจัดเก็บข้อมูล 

### เปรียบเทียบการใช้ วิเคราะห์ประสิทธิภาพของ RocksDB กับโหลดงานของ SPFresh โปรเจคระดับ 10K request/sec และมีข้อมูล 1Billion record (คาดการ)

จากการวิเคราะห์ประสิทธิภาพของ RocksDB กับโหลดงานของ SPFresh ที่มีปริมาณ 10,000 คำขอต่อวินาที และมีข้อมูล 1 พันล้านรายการ พบว่า RocksDB สามารถรองรับโหลดงานได้ แต่ทำงานใกล้ขีดจำกัดประสิทธิภาพสูงสุด โดยมีประเด็นสำคัญดังนี้:

### สรุปการวิเคราะห์ประสิทธิภาพ RocksDB (โหลดงาน 10,000 req/sec, 1 พันล้านรายการ)

**RocksDB รองรับโหลดงานระดับสูงได้ แต่ใกล้ขีดจำกัดของประสิทธิภาพ**

#### ประสิทธิภาพการอ่าน
- **ความหน่วงเฉลี่ย:** 12 ms (P99: 45 ms)
- **ปริมาณการอ่าน:** 7,000 รายการ/วินาที (70% ของโหลดงาน)
- **อัตราการเข้าถึงแคช:** 82% (LRU Cache 3GB)
- **Read Amplification:** 2.8 เท่า (อยู่ในเกณฑ์ดี)

#### ประสิทธิภาพการเขียน
- **ความหน่วงเฉลี่ย:** 18 ms (P99: 65 ms)
- **ปริมาณการเขียน:** 3,000 รายการ/วินาที (30% ของโหลดงาน)
- **Write Amplification:** 5.2 เท่า (สูงกว่าที่ควร)
- **ผลกระทบจากการบีบอัด:** ปานกลาง (มี latency spike ระหว่าง compaction)

#### ขีดจำกัดโดยประมาณ (ต่อ 1 instance)
| ประเภท | จำนวน (ต่อวินาที) |
|--------|-------------------|
| อ่าน   | 7,000 - 8,000     |
| เขียน  | 3,000 - 4,000     |
| รวม    | 10,000 - 12,000   |

---

### แนวทางการขยายขนาดเพื่อรองรับโหลดงานที่สูงขึ้น

#### 1. Vertical Scaling (ขยายแนวตั้ง)
- เพิ่ม RAM (เช่น 256GB) เพื่อขยาย block cache
- ใช้ NVMe SSD (PCIe 4.0) เพื่อเพิ่ม I/O throughput
- **ผลลัพธ์ที่คาดหวัง:** throughput สูงขึ้น 30-40%

#### 2. Horizontal Scaling (ขยายแนวนอน)
- แบ่งส่วนข้อมูล (sharding) ข้ามหลาย RocksDB instance
- ใช้ consistent hashing เพื่อกระจายโหลด
- **ผลลัพธ์ที่คาดหวัง:** scaling เกือบเป็นเชิงเส้นตามจำนวน shard

#### 3. Hybrid Approach (แนวทางผสม)
- Hot data อยู่ใน RocksDB (local SSD)
- Cold data อยู่ใน object storage (เช่น S3/GCS) พร้อมชั้น cache
- **ผลลัพธ์ที่คาดหวัง:** ประสิทธิภาพต่อต้นทุนดีขึ้นสำหรับ dataset ใหญ่

### Data Flow สำหรับการเขียน (Write)
```
┌───────────────────────────────────────────────────────────────────────────┐
│                       WRITE DATA FLOW COMPARISON                          │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                     RocksDB on Cloud                                │  │
│  │                                                                     │  │
│  │  Client ───────► API ───────► SPFresh Core ───────► RocksDB MemTable│  │
│  │                                                       │             │  │
│  │                                                       │             │  │
│  │                                                       ▼             │  │
│  │                                                  Disk (SST/Blob)    │  │
│  │                                                       │             │  │
│  │                                                       │             │  │
│  │  Client ◄─────── API ◄─────── SPFresh Core ◄──────────┘             │  │
│  │                                                                     │  │
│  │  Throughput: High (limited by disk I/O)                             │  │
│  │  Durability: Medium (depends on disk type)                          │  │
│  │  Complexity: Low                                                    │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                     Cloud Storage Only                              │  │
│  │                                                                     │  │
│  │  Client ───────► API ───────► SPFresh Core ───────► Write Buffer    │  │
│  │                                                       │             │  │
│  │                                                       │             │  │
│  │                                                       ▼             │  │
│  │                                                  Cloud Storage      │  │
│  │                                                       │             │  │
│  │                                                       │             │  │
│  │  Client ◄─────── API ◄─────── SPFresh Core ◄──────────┘             │  │
│  │                                                                     │  │
│  │  Throughput: Medium (limited by network)                            │  │
│  │  Durability: High (cloud storage replication)                       │  │
│  │  Complexity: Medium                                                 │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                     Hybrid Approach                                 │  │
│  │                                                                     │  │
│  │  Client ───────► API ───────► SPFresh Core ───────► RocksDB MemTable│  │
│  │                                                       │             │  │
│  │                                                       │             │  │
│  │                                                       ▼             │  │
│  │                                                  Disk Storage       │  │
│  │                                                       │             │  │
│  │                                                       │             │  │
│  │                                                       ▼             │  │
│  │                                                  Cloud Backup       │  │
│  │                                                  (Asynchronous)     │  │
│  │                                                       │             │  │
│  │                                                       │             │  │
│  │  Client ◄─────── API ◄─────── SPFresh Core ◄──────────┘             │  │
│  │                                                                     │  │
│  │  Throughput: High (similar to RocksDB)                              │  │
│  │  Durability: High (local + cloud backup)                            │  │
│  │  Complexity: High                                                   │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

### Data Flow สำหรับการค้นหา (Search)
```
┌───────────────────────────────────────────────────────────────────────────┐
│                       SEARCH DATA FLOW COMPARISON                         │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                     RocksDB on Cloud                                │  │
│  │                                                                     │  │
│  │  Client ───────► API ───────► SPFresh Core ───────► RocksDB         │  │
│  │                                                       │             │  │
│  │                                                       │             │  │
│  │                                                       ▼             │  │
│  │                                                  Disk Storage       │  │
│  │                                                       │             │  │
│  │                                                       │             │  │
│  │  Client ◄─────── API ◄─────── SPFresh Core ◄──────────┘             │  │
│  │                                                                     │  │
│  │  Latency: Low (all data local to VM)                               │  │
│  │  Scalability: Limited by VM resources                              │  │
│  │  Complexity: Low                                                    │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                     Cloud Storage Only                              │  │
│  │                                                                     │  │
│  │  Client ───────► API ───────► SPFresh Core ───────► Cloud Storage   │  │
│  │                                                       │             │  │
│  │                                                       │             │  │
│  │                                                       │             │  │
│  │                                                       │             │  │
│  │                                                       │             │  │
│  │                                                       │             │  │
│  │  Client ◄─────── API ◄─────── SPFresh Core ◄──────────┘             │  │
│  │                                                                     │  │
│  │  Latency: Higher (network calls to cloud storage)                  │  │
│  │  Scalability: Excellent                                            │  │
│  │  Complexity: Medium                                                │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                     Hybrid Approach                                 │  │
│  │                                                                     │  │
│  │  Hot Data:                                                          │  │
│  │  Client ───────► API ───────► SPFresh Core ───────► RocksDB         │  │
│  │                                                       │             │  │
│  │                                                       │             │  │
│  │  Client ◄─────── API ◄─────── SPFresh Core ◄──────────┘             │  │
│  │                                                                     │  │
│  │  Cold Data:                                                         │  │
│  │  Client ───────► API ───────► SPFresh Core ───────► Cloud Storage   │  │
│  │                                                       │             │  │
│  │                                                       │             │  │
│  │  Client ◄─────── API ◄─────── SPFresh Core ◄──────────┘             │  │
│  │                                                                     │  │
│  │  Latency: Low for hot data, higher for cold data                   │  │
│  │  Scalability: Good (limited for hot data, excellent for cold)      │  │
│  │  Complexity: High                                                  │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘ 
```

## Storage Alternatives Comparison for SPFresh



| คุณสมบัติ                | RocksDB on Cloud      | Cloud Storage         | Hybrid Approach             |
|------------------------|-----------------------|-----------------------|-----------------------------|
| Read Latency           | Low                   | High                  | Low (hot) / High (cold)     |
| Write Throughput       | High                  | Medium                | High                        |
| Scalability            | Limited               | Excellent             | Good                        |
| Durability             | Medium                | High                  | High                        |
| Complexity             | Low                   | Medium                | High                        |
| Management             | Difficult             | Easy                  | Medium                      |
| Cost                   | High when scaling     | Usage-based           | Medium                      |
| Development Effort     | Low                   | High                  | Very High                   |
| Regional Distribution  | Difficult             | Easy                  | Medium                      |
| Customization          | High                  | Low                   | Medium                      |
| Large Data Support     | Low                   | High                  | High                        |
| Growth Support         | Limited               | Unlimited             | Good                        |
---

###  Post-Write Processing

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Post-Write Processing                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. Success Response                                                │
│  {                                                                  │
│    "status": "ok",                                                 │
│    "inserted": 3,                                                  │
│    "updated": 0,                                                   │
│    "deleted": 0,                                                   │
│    "errors": []                                                    │
│  }                                                                  │
│                                                                     │
│  2. Async Index Building Trigger                                    │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐         │
│  │ WAL Monitor │────▶│Index Queue  │────▶│Index Builder│         │
│  │  (Polling)  │     │  (In-Memory)│     │  (Workers)  │         │
│  └─────────────┘     └─────────────┘     └─────────────┘         │
│                                                                     │
│  3. Cache Invalidation                                              │
│  - Invalidate affected namespace cache entries                     │
│  - Update namespace metadata (doc count, last write time)          │
│  - Trigger pre-warming if configured                               │
└─────────────────────────────────────────────────────────────────────┘
```

## SPFresh reverse index architecture

```
┌───────────────────────┐
│                       │
│    USER SEARCH        │
│    REQUEST            │
│                       │
└──────────┬────────────┘
           │
           ▼
┌──────────────────────┐
│                      │
│   API LAYER          │
│   (Rust/Axum)        │
│                      │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│                      │
│   QUERY PARSER       │
│                      │
└────────────┬─────────┘
             │
 ┌───────────────┬──────────────────┬─────────────────┐
 │               │                  │                 │
 ▼               ▼                  ▼                 ▼
┌───────────────────┐ ┌────────────────────┐ ┌───────────────────┐ ┌───────────────────┐
│ METADATA FILTER   │ │ VECTOR SIMILARITY  │ │ FULLTEXT SEARCH   │ │ PAGINATION &      │
│ PROCESSING        │ │ SEARCH             │ │ PROCESSING        │ │ SORTING           │
└────────┬──────────┘ └─────────┬──────────┘ └────────┬──────────┘ └────────┬──────────┘
         │                      │                     │                     │
         ▼                      ▼                     ▼                     │
┌───────────────────┐ ┌────────────────────┐ ┌───────────────────┐          │
│  METADATA INDEX   │ │  VECTOR INDEX      │ │  FULLTEXT INDEX   │          │
│                   │ │                    │ │                   │          │
│  Field → IDs      │ │  Centroid → IDs    │ │  Term → IDs      │          │
│                   │ │                    │ │                   │          │
│  category:        │ │  Centroid 1        │ │  "smartphone"     │          │
│  electronics      │ │  ↓                 │ │  ↓                │          │
│  ↓                │ │  [ID1, ID5, ID9]   │ │  [ID1, ID7]       │          │
│  [ID1, ID5, ID9]  │ │                    │ │                   │          │
│                   │ │  Centroid 2        │ │  "wireless"       │          │
│  price:           │ │  ↓                 │ │  ↓                │          │
│  range(0,100)     │ │  [ID2, ID7, ID8]   │ │  [ID5, ID9]       │          │
│  ↓                │ │                    │ │                   │          │
│  [ID2, ID7, ID8]  │ │                    │ │                   │          │
└────────┬──────────┘ └─────────┬──────────┘ └────────┬──────────┘          │
         │                      │                     │                     │
         └──────────┬───────────┴─────────────────────┘                     │
                    │                                                       │
                    ▼                                                       │
           ┌────────────────────┐                                           │
           │  RESULT CANDIDATE  │                                           │
           │  SET               │                                           │
           └────────┬───────────┘                                           │
                    │                                                       │
                    └─────────────────┬───────────────────────────────────┬─┘
                                      │                                   │
                                      ▼                                   │
                           ┌────────────────────┐                         │
                           │  ID MAPPING        │                         │
                           │                    │                         │
                           │  Vector ID → Meta  │                         │
                           │                    │                         │
                           │  ID1 → {title: "A",│                         │
                           │        category: "B"}                        │
                           │                    │                         │
                           │  ID2 → {title: "C",│                         │
                           │        category: "D"}                        │
                           │                    │                         │
                           └────────┬───────────┘                         │
                                    │                                     │
                                    ▼                                     │
                           ┌────────────────────┐                         │
                           │                    │                         │
                           │  FINAL RESULTS     │◀────────────────────────┘
                           │                    │
                           └────────┬───────────┘
                                    │
                                    ▼
                           ┌────────────────────┐
                           │                    │
                           │  USER RESPONSE     │
                           │                    │
                           └────────────────────┘
```

##  Object Storage Backend
```
┌───────────────────────────────────────────────────────────────────────────┐
│                       SPFRESH ARCHITECTURE WITH                           │
│                       OBJECT STORAGE BACKEND                              │
└───────────────────────────────────────────────────────────────────────────┘
                                    │
                 ┌─────────────────┬┴┬─────────────────┐
                 │                 │ │                 │
                 ▼                 ▼ ▼                 ▼
┌───────────────────────┐ ┌───────────────────┐ ┌───────────────────────┐
│  QUERY PROCESSING     │ │  INDEX MANAGEMENT  │ │  WRITE OPERATIONS    │
│                       │ │                    │ │                      │
│  • Search             │ │  • Rebalancing     │ │  • Upsert           │
│  • Filter             │ │  • Optimization    │ │  • Update           │
│  • Fulltext           │ │  • Compression     │ │  • Delete           │
└─────────┬─────────────┘ └────────┬──────────┘ └──────────┬───────────┘
          │                        │                       │
          └────────────────────────┼───────────────────────┘
                                   │
                                   ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                       IN-MEMORY COMPONENTS                                │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐│
│  │  Centroid Index     │  │  Recent Vectors     │  │  Metadata Cache     ││
│  │  (HNSW/IVF)         │  │  (Write Buffer)     │  │  (LRU Cache)        ││
│  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘│
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                       ROCKSDB LAYER                                       │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐│
│  │  Metadata Index     │  │  Posting Lists      │  │  WAL Buffer         ││
│  │  (Key-Value Store)  │  │  (SST Files)        │  │  (Log Files)        ││
│  └─────────────────────┘  └─────────────────────┘  └─────────────────────┘│
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                       OBJECT STORAGE BACKEND                              │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  Object Storage (GCS/S3/Azure)                                      │  │
│  │  ├── namespace-1/                                                   │  │
│  │  │   ├── wal/                                                       │  │
│  │  │   │   ├── entry-001.log                                          │  │
│  │  │   │   ├── entry-002.log                                          │  │
│  │  │   │   └── ...                                                    │  │
│  │  │   ├── vectors/                                                   │  │
│  │  │   │   ├── spfresh-index/                                         │  │
│  │  │   │   └── clusters/                                              │  │
│  │  │   ├── fulltext/                                                  │  │
│  │  │   │   └── bm25-index/                                            │  │
│  │  │   └── metadata/                                                  │  │
│  │  │       └── exact-indexes/                                         │  │
│  │  ├── namespace-2/                                                   │  │
│  │  └── ...                                                            │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```
### Write Flow (Upsert/Update/Delete)
```
┌───────────────┐     ┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│ API Request   │────▶│ Write Buffer  │────▶│ WAL Buffer    │────▶│ Object Storage│
│ (Upsert)      │     │ (In-Memory)   │     │ (RocksDB)     │     │ (wal/*.log)   │
└───────────────┘     └───────────────┘     └───────────────┘     └───────────────┘
                             │                                            ▲
                             │                                            │
                             ▼                                            │
                      ┌───────────────┐     ┌───────────────┐             │
                      │ Index Update  │────▶│ Background    │─────────────┘
                      │ (Async)       │     │ Flush         │
                      └───────────────┘     └───────────────┘
```

### Read Flow (Search/Query)
```
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│ API Request   │────▶│ Query Parser  │────▶│ In-Memory     │
│ (Search)      │     │               │     │ Indices       │
└───────────────┘     └───────────────┘     └───────┬───────┘
                                                   │
                                                   │ Cache Miss
                                                   ▼
                                            ┌───────────────┐
                                            │ RocksDB       │
                                            │ Indices       │
                                            └───────┬───────┘
                                                   │
                                                   │ Not Found
                                                   ▼
                                            ┌───────────────┐
                                            │ Object Storage│
                                            │ Fetch         │
                                            └───────────────┘
```



## โครงสร้างการเก็บข้อมูล 

```
┌─────────────────────────────────────────────────────────────────────────────┐
│        SPFresh Data Storage Location & Format (Native use RocksDB)          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  เมื่อคุณใส่ embedding ข้อมูลจะไปเก็บที่:                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ Path: ตามที่ตั้งใน m_KVPath configuration                               │    │
│  │                                                                     │    │
│  │ ตัวอย่าง:                                                             │    │
│  │ options.m_KVPath = "/data/spfresh/rocksdb";                         │    │
│  │                                                                     │    │
│  │ ข้อมูลจะถูกเก็บใน directory นี้:                                          │    │
│  │ /data/spfresh/rocksdb/                                              │    │
│  │ ├── 000003.log          # WAL file (ถ้าเปิด WAL)                      │    │
│  │ ├── 000004.sst          # SST files (sorted string tables)         │    │
│  │ ├── 000005.sst                                                     │    │
│  │ ├── 000006.blob         # Blob files (สำหรับ vector data)           │    │
│  │ ├── CURRENT             # Current manifest file                    │    │
│  │ ├── IDENTITY            # Database identity                        │    │
│  │ ├── LOCK                # Database lock file                       │    │
│  │ ├── MANIFEST-000001     # Metadata about SST files                 │    │
│  │ └── OPTIONS-000007      # RocksDB options                          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  รูปแบบการเก็บข้อมูล:                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ Key-Value Format:                                                   │    │
│  │                                                                     │    │
│  │ Key: SizeType (4 bytes integer)                                     │    │
│  │ │                                                                   │    │
│  │ │ ┌─────────────────────────────────────────────────────────────┐   │    │
│  │ └▶│ Vector ID (เช่น 1, 2, 3, ...)                                │   │    │
│  │   └─────────────────────────────────────────────────────────────┘   │    │
│  │                                                                     │    │
│  │ Value: Binary Data (vector + metadata)                              │    │
│  │ │                                                                   │    │
│  │ │ ┌─────────────────────────────────────────────────────────────┐   │    │
│  │ └▶│ Vector Data: [0.1, 0.2, 0.3, ...] (float array)             │   │    │
│  │   │ Metadata: attributes, timestamps, etc.                      │   │    │
│  │   └─────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  File Structure Details:                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ SST Files (.sst):                                                   │    │
│  │ • ขนาด: 128MB base, 256MB, 512MB, 1GB (multiplier = 2)              │    │
│  │ • เก็บ key-value pairs ที่ sorted                                      │    │
│  │ • มี Bloom filter สำหรับ fast lookup                                  │    │
│  │ • Compressed ด้วย LZ4/ZSTD                                           │    │
│  │                                                                     │    │
│  │ Blob Files (.blob):                                                 │    │
│  │ • ขนาด: 8GB per file                                                │    │
│  │ • เก็บ vector data ที่ใหญ่กว่า 64 bytes                                 │    │
│  │ • ไม่มี compression (เพื่อความเร็ว)                                       │    │
│  │ • มี garbage collection                                              │    │
│  │                                                                     │    │
│  │ WAL Files (.log):                                                   │    │
│  │ • เก็บ write operations ก่อน commit                                   │    │
│  │ • ใช้สำหรับ crash recovery                                            │    │
│  │ • ถ้าปิด WAL จะไม่มีไฟล์นี้                                               │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│  การทำงานของ RocksDB:                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ 1. เมื่อใส่ embedding:                                                  │    │
│  │    • ข้อมูลเข้า MemTable (RAM) ก่อน                                     │    │
│  │    • เมื่อ MemTable เต็ม → flush เป็น SST file                           │    │
│  │    • Vector ใหญ่ → เก็บใน Blob file                                   │    │
│  │                                                                     │    │
│  │ 2. Background Compaction:                                           │    │
│  │    • รวม SST files เก่า → SST files ใหม่                               │    │
│  │    • ลบข้อมูลซ้ำและข้อมูลที่ถูกลบ                                         │    │
│  │    • จัดเรียงข้อมูลให้เหมาะสำหรับการค้นหา                                  │    │
│  │                                                                     │    │
│  │ 3. การค้นหา:                                                         │    │
│  │    • ค้นหาใน MemTable ก่อน                                           │    │
│  │    • ใช้ Bloom filter ใน SST files                                   │    │
│  │    • ใช้ LRU cache (3GB) สำหรับข้อมูลที่ใช้บ่อย                            │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

ที่เก็บ: ใน directory ที่ตั้งใน m_KVPath (เช่น /data/spfresh/rocksdb/)

รูปแบบไฟล์:

SST files: เก็บ Vector ID → Vector Data mappings
Blob files: เก็บ vector embeddings ขนาดใหญ่
MANIFEST: ติดตาม SST files ทั้งหมด
CURRENT: ชี้ไปยัง MANIFEST ปัจจุบัน
OPTIONS: เก็บ configuration ที่ตั้งไว้
IDENTITY: unique ID ของ database
LOCK: ป้องกันการเปิดหลาย process
WAL files: ไม่มี (เพราะ SPFresh ปิดใช้งาน)

รูปแบบข้อมูล:

Key: Vector ID (4 bytes integer)
Value: Vector data + metadata (binary format)

การจัดการ:

Background compaction
Garbage collection
LRU cache (3GB)
Bloom filters

```


